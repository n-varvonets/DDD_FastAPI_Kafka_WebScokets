# DDD: Entities, Aggregates, Value Objects и Use Cases

## Итак, что определяет предметную область в DDD?
✅ **Сущности (Entities)** – основа, но они не единственные.  
✅ **Агрегаты (Aggregates)** – группируют сущности и управляют их целостностью.  
✅ **Value Objects** – определяют значения без идентичности.  
✅ **Доменные сервисы (Domain Services)** – обрабатывают логику, выходящую за рамки одной сущности. Сервис не имеет собственного состояния; он выполняет действие.

✅ **Доменные события (Domain Events)** – фиксируют изменения в бизнес-логике.  
✅ **Use Cases** – управляют последовательностью действий в системе.  

# Но репозиторий не определяет предметную область – он лишь служит способом взаимодействия доменных объектов с хранилищем данных.

## Чем отличаются Value Objects от Сущностей?
Основное различие между **Сущностями (Entities)** и **Объектами-значениями (Value Objects)** заключается в их идентичности и изменяемости:

- **Сущности (Entities):**
  - **Идентичность:** Каждая сущность имеет уникальный идентификатор (например, `id`). Даже если две сущности имеют одинаковые свойства, они считаются разными, если их идентификаторы различаются.
  - **Изменяемость:** Сущности могут изменять своё состояние в течение жизненного цикла.

  *Пример:* Пользователь (`User`) с уникальным `ID`, который может менять своё имя или email.

- **Объекты-значения (Value Objects):**
  - **Идентичность:** Не имеют уникального идентификатора. Два объекта-значения считаются одинаковыми, если их свойства совпадают.
  - **Неизменяемость:** После создания их состояние не изменяется. Если нужно изменить значение, создаётся новый объект.

  *Пример:* `Address` с полями `street`, `city`, `zipcode`. Два адреса считаются одинаковыми, если все их поля совпадают.

Таким образом, сущности важны своей уникальностью, а объекты-значения — набором своих свойств.

## На каком уровне располагаются Сущности, Агрегаты и Value Objects в Domain Logic?
DDD организует **Domain Logic** так, чтобы было легко управлять сложностью системы. Структура часто включает:

- **Entities (Сущности)** – Определяют объекты с уникальной идентичностью.
- **Aggregates (Агрегаты)** – Объединяют связанные сущности, контролируют их целостность.
- **Value Objects (Объекты-значения)** – Описывают свойства без уникальной идентичности.
- **Domain Services (Доменные сервисы)** – Выполняют операции, выходящие за границы одной сущности. Сервис не имеет собственного состояния; он выполняет действие.
- **Use Cases (Приложение)** – Координируют выполнение бизнес-логики.

На основе структуры проекта, как в приведённом коде:

- **Папка `entities/` содержит `Chat`, который имеет методы `add_message` и `create_chat`.**
  - Это **агрегат**, потому что `Chat` управляет коллекцией `Message` и обрабатывает логику добавления сообщений.
  - `Chat` – это **корневая сущность (Aggregate Root)**, а `Message` – его часть.

### Почему `Chat` – агрегат, а не просто сущность?
- **Корневой агрегат (`Chat`) управляет жизненным циклом вложенных сущностей (`Message`).**
- **Взаимодействие с `Message` должно происходить через `Chat`.**
- **Целостность данных обеспечивается в рамках агрегата (`add_message`).**

### Можно ли в Сущностях обрабатывать другие Сущности?
Обычно **сущности** управляют только своим состоянием. Если требуется работа с другими сущностями, их группируют в **агрегат**, и корневая сущность агрегата отвечает за управление ими.

## Что такое Доменные сервисы и когда их использовать?
**Доменные сервисы (Domain Services)** используются для реализации бизнес-логики, которая:
- **Неестественно вписывается в методы одной сущности или агрегата.**
- **Требует работы с несколькими сущностями или агрегатами.**
- **Не привязана к конкретному объекту.**

### Пример доменного сервиса:
```python
class DeliveryCostService:
    def calculate_cost(self, order, destination):
        # Логика расчёта стоимости доставки
        pass
```
Этот сервис используется в **Use Case**, который управляет последовательностью бизнес-процессов.

### Как отличить доменный сервис от метода сущности?
Если логика:
- **Касается одной сущности** → это **метод сущности**.
- **Затрагивает несколько сущностей/агрегатов** → это **доменный сервис**.

## Заключение
- **Entities (Сущности)** управляют данными и изменениями.
- **Aggregates (Агрегаты)** контролируют связанные сущности.
- **Value Objects (Объекты-значения)** обеспечивают неизменяемые свойства.
- **Use Cases (Приложение)** управляют процессами.
- **Domain Services (Доменные сервисы)** решают задачи, выходящие за рамки одной сущности.
- # Сервис не имеет собственного состояния; он выполняет действие.
- **Domain Events (События)** фиксируют изменения.

Эти концепции помогают строить **гибкую, тестируемую и расширяемую архитектуру** в DDD.
